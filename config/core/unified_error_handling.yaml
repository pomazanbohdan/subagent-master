# Unified Error Handling System
# Standardized error handling with Claude Code native fallbacks

metadata:
  name: "unified-error-handling"
  version: "1.0.0"
  description: "Unified error handling system with automatic Claude Code fallback integration"
  author: "Master Agent System v3.6.0"

# Error Classification System
error_classification:
  categories:
    critical:
      description: "System-blocking errors requiring immediate intervention"
      severity: "critical"
      auto_recovery: false
      claude_fallback_required: true
      examples:
        - "no_agents_available"
        - "system_initialization_failure"
        - "configuration_corruption"
        - "mcp_server_unavailable"

    high:
      description: "High-priority errors affecting task completion"
      severity: "high"
      auto_recovery: true
      claude_fallback_available: true
      examples:
        - "agent_timeout"
        - "selection_failure"
        - "coordination_deadlock"
        - "performance_degradation"

    medium:
      description: "Medium-priority errors with workarounds available"
      severity: "medium"
      auto_recovery: true
      claude_fallback_optional: true
      examples:
        - "partial_failure"
        - "resource_constraint"
        - "quality_threshold_miss"
        - "retry_required"

    low:
      description: "Low-priority errors with minimal impact"
      severity: "low"
      auto_recovery: true
      claude_fallback_not_needed: true
      examples:
        - "non_critical_timeout"
        - "minor_quality_issue"
        - "resource_optimization_opportunity"
        - "performance_variance"

# Unified Error Response Strategy
error_response_strategy:
  immediate_actions:
    error_detection:
      action: "Classify and log error"
      timeout: 5  # seconds
      claude_fallback_if_timeout: true

    error_containment:
      action: "Prevent error propagation"
      isolation_required: true
      claude_fallback_if_isolation_fails: true

    user_notification:
      action: "Inform user of error status"
      notification_level: "error"
      claude_fallback_if_notification_fails: true

  recovery_actions:
    automatic_recovery:
      enabled: true
      max_attempts: 3
      backoff_strategy: "exponential"
      claude_fallback_after_attempts: 2

    graceful_degradation:
      enabled: true
      degradation_levels: 3
      claude_fallback_at_level_2: true

    claude_native_fallback:
      enabled: true
      trigger_conditions:
        - "automatic_recovery_failed"
        - "no_suitable_agents_available"
        - "system_overload_detected"
        - "user_requested_fallback"

# Claude Code Native Fallback System
claude_code_fallback_system:
  activation_triggers:
    system_failure:
      - "all_agents_unavailable"
      - "critical_initialization_error"
      - "configuration_corruption"
      - "timeout_exceeded"

    performance_issues:
      - "response_time > 30_seconds"
      - "error_rate > 20%"
      - "resource_exhaustion"
      - "user_timeout"

    user_preference:
      - "user_requests_direct_execution"
      - "simplification_requested"
      - "fallback_preferred"

  claude_native_capabilities:
    file_operations:
      tools: ["Read", "Write", "Edit", "Glob", "Grep"]
      fallback_strategy: "direct_file_manipulation"
      quality_assurance: "automatic_validation"

    web_operations:
      tools: ["WebFetch", "WebSearch"]
      fallback_strategy: "direct_web_access"
      quality_assurance: "source_validation"

    mcp_operations:
      tools: ["All available MCP servers"]
      fallback_strategy: "direct_mcp_usage"
      quality_assurance: "server_health_check"

    bash_operations:
      tools: ["Bash"]
      fallback_strategy: "direct_command_execution"
      quality_assurance: "command_validation"

    delegation_operations:
      tools: ["Task"]
      fallback_strategy: "direct_task_delegation"
      quality_assurance: "result_validation"

  fallback_execution_strategies:
    direct_execution:
      description: "Execute task directly using Claude Code tools"
      process:
        1. "Analyze task requirements"
        2. "Select appropriate Claude Code tools"
        3. "Execute task in coordinated manner"
        4. "Validate and present results"

    parallel_execution:
      description: "Use Claude Code parallel processing capabilities"
      process:
        1. "Identify parallelizable components"
        2. "Execute tool calls in parallel"
        3. "Synthesize results"
        4. "Handle conflicts and dependencies"

    simplified_execution:
      description: "Execute simplified version of task"
      process:
        1. "Identify core requirements"
        2. "Remove non-essential complexity"
        3. "Execute using basic Claude Code tools"
        4. "Provide incremental improvements"

# Error Recovery Workflows
recovery_workflows:
  workflow_template:
    error_detection:
      step_1: "Detect and classify error"
      step_2: "Log error details with context"
      step_3: "Trigger appropriate response strategy"
      timeout: 10  # seconds

    immediate_response:
      step_1: "Apply immediate containment actions"
      step_2: "Notify user of error status"
      step_3: "Prepare recovery strategy"
      timeout: 5  # seconds

    recovery_execution:
      step_1: "Attempt automatic recovery (3 attempts max)"
      step_2: "Apply graceful degradation if needed"
      step_3: "Activate Claude Code fallback if required"
      timeout: 60  # seconds

    validation_and_completion:
      step_1: "Validate recovery success"
      step_2: "Complete task using fallback strategy"
      step_3: "Log recovery outcome and learn from it"
      timeout: 30  # seconds

  specific_workflows:
    agent_selection_failure:
      error_detection:
        criteria: "no_suitable_agents_found OR confidence_below_threshold"

      recovery_actions:
        - "expand_search_criteria"
        - "lower_confidence_threshold"
        - "enable_cross_domain_search"
        - "claude_direct_execution"

      claude_fallback:
        trigger: "after_expansion_fails"
        strategy: "direct_execution_with_available_tools"

    coordination_deadlock:
      error_detection:
        criteria: "circular_dependencies OR timeout_exceeded"

      recovery_actions:
        - "break_dependency_cycles"
        - "prioritize_critical_paths"
        - "sequential_execution"
        - "claude_parallel_processing"

      claude_fallback:
        trigger: "after_dependency_break_fails"
        strategy: "parallel_execution_without_coordination"

    performance_degradation:
      error_detection:
        criteria: "response_time > 30s OR error_rate > 20%"

      recovery_actions:
        - "reduce_concurrent_operations"
        - "increase_timeout_values"
        - "simplify_processing"
        - "claude_optimized_execution"

      claude_fallback:
        trigger: "after_optimization_fails"
        strategy: "simplified_execution_with_core_features"

# Quality Assurance and Validation
validation_system:
  error_recovery_validation:
    success_criteria:
      - "task_completion_achieved"
      - "quality_thresholds_met"
      - "user_acceptance_obtained"
      - "no_new_errors_introduced"

    failure_criteria:
      - "recovery_attempts_exhausted"
      - "claude_fallback_failed"
      - "user_rejection"
      - "new_critical_errors_introduced"

  fallback_effectiveness_metrics:
    success_rate: "Percentage of successful fallback activations"
    response_time: "Time from fallback activation to task completion"
    quality_preservation: "Maintenance of task quality standards"
    user_satisfaction: "User acceptance of fallback results"

# Learning and Adaptation
learning_system:
  error_pattern_recognition:
    enabled: true
    data_sources:
      - "error_logs"
      - "recovery_attempts"
      - "fallback_activations"
      - "user_feedback"

    learning_objectives:
      - "Identify recurring error patterns"
      - "Optimize recovery strategies"
      - "Improve fallback trigger conditions"
      - "Enhance claude_fallback_effectiveness"

  adaptive_improvement:
    enabled: true
    improvement_mechanisms:
      - "automatic_threshold_adjustment"
      - "recovery_strategy_optimization"
      - "fallback_trigger_refinement"
      - "performance_baseline_update"

# Integration Points
integration:
  required_imports:
    - "config/knowledge-base/unified_agent_selection.yaml"
    - "config/dynamic/runtime_environment.yaml"

  exports:
    - "error_handling_status"
    - "fallback_activation_log"
    - "recovery_performance_metrics"
    - "claude_native_usage_statistics"

  claude_code_integration:
    direct_tool_access: true
    parallel_execution_support: true
    mcp_server_coordination: true
    task_delegation_capabilities: true

# Configuration Management
configuration:
  error_handling_enabled: true
  claude_fallback_enabled: true
  automatic_recovery_enabled: true
  learning_system_enabled: true

  timeout_values:
    error_detection: 5  # seconds
    immediate_response: 5  # seconds
    recovery_execution: 60  # seconds
    validation_and_completion: 30  # seconds

  thresholds:
    max_recovery_attempts: 3
    max_fallback_activations: 2
    error_rate_threshold: 0.20  # 20%
    response_time_threshold: 30  # seconds
# MCP Server Registry System
# Dynamic MCP server discovery, registration, and management system

metadata:
  name: "mcp-server-registry"
  version: "1.0.0"
  description: "Dynamic MCP server registry with auto-discovery, health monitoring, and load balancing"
  author: "Master Agent System v3.5.0"

# Server Discovery Configuration
server_discovery:
  enabled: true
  discovery_methods:
    environment_variable_discovery:
      enabled: true
      env_variable: "MCP_SERVERS"
      format: "server_name:host:port,server2_name:host2:port2"
      priority: 1
      timeout: 5
      
    configuration_file_discovery:
      enabled: true
      search_paths:
        - "config/mcp_servers/*.yaml"
        - "config/mcp_servers/*.json"
        - ".claude-plugin/mcp_servers.yaml"
        - "mcp_servers.json"
      priority: 2
      timeout: 10
      
    runtime_registration:
      enabled: true
      registration_endpoint: "/mcp/register"
      protocol: "http_rest_api"
      priority: 3
      timeout: 15
      
    service_discovery:
      enabled: true
      methods:
        - "dns_sd"
        - "consul"
        - "kubernetes"
      priority: 4
      timeout: 20

# Dynamic Registration System
dynamic_registration:
  enabled: true
  registration_protocol:
    name: "mcp_v2_registration"
    version: "2.0"
    
  registration_fields:
    required_fields:
      - server_id
      - server_name
      - server_version
      - host
      - port
      - capabilities
      - health_endpoint
      
    optional_fields:
      - description
      - tags
      - priority
      - max_connections
      - timeout
      - authentication_required
      
    capability_fields:
      - supported_operations
      - data_formats
      - security_features
      - performance_characteristics
      - limitations
      
  validation_rules:
    server_id_validation:
      pattern: "^[a-zA-Z0-9_-]+$"
      min_length: 3
      max_length: 50
      unique_required: true
      
    network_validation:
      host_format: "ipv4_or_hostname"
      port_range: [1024, 65535]
      connectivity_check: true
      timeout_test: 5
      
    capability_validation:
      required_capabilities: ["basic_functionality"]
      capability_format_validation: true
      version_compatibility_check: true

# Server Registry Storage
registry_storage:
  storage_type: "memory_with_file_backup"
  
  memory_storage:
    enabled: true
    max_entries: 100
    eviction_policy: "least_recently_used"
    cleanup_interval: 300  # seconds
    
  file_backup:
    enabled: true
    backup_file: "config/dynamic/mcp_registry_backup.yaml"
    backup_frequency: "every_5_minutes"
    compression: true
    
  registry_structure:
    server_entry:
      server_id: "string"
      server_info:
        name: "string"
        version: "string"
        description: "string"
        host: "string"
        port: "integer"
        url: "string"
        tags: "array"
        
      capabilities:
        supported_operations: "array"
        data_formats: "array"
        security_features: "array"
        performance_characteristics: "object"
        limitations: "array"
        
      health_status:
        status: "enum[healthy, degraded, unhealthy, unknown]"
        last_check: "timestamp"
        response_time: "float"
        uptime_percentage: "float"
        error_rate: "float"
        
      performance_metrics:
        avg_response_time: "float"
        success_rate: "float"
        throughput: "float"
        connection_count: "integer"
        
      registration_info:
        registered_at: "timestamp"
        last_updated: "timestamp"
        registration_source: "string"
        priority: "integer"

# Health Monitoring System
health_monitoring:
  enabled: true
  monitoring_interval: 30  # seconds
  
  health_checks:
    basic_connectivity:
      enabled: true
      endpoint: "/health"
      method: "GET"
      timeout: 5
      expected_status: 200
      weight: 0.4
      
    capability_verification:
      enabled: true
      endpoint: "/capabilities"
      method: "GET"
      timeout: 10
      expected_capabilities: "subset_of_registered_capabilities"
      weight: 0.3
      
    performance_test:
      enabled: true
      endpoint: "/ping"
      method: "POST"
      timeout: 3
      max_response_time: 1000  # milliseconds
      weight: 0.3
      
  health_status_calculation:
    healthy_threshold: 0.8
    degraded_threshold: 0.5
    unhealthy_threshold: 0.2
    
    status_weights:
      connectivity_weight: 0.4
      capability_weight: 0.3
      performance_weight: 0.3
      
  failure_detection:
    consecutive_failures: 3
    failure_timeout: 60  # seconds
    recovery_check_interval: 30  # seconds
    automatic_recovery: true

# Load Balancing System
load_balancing:
  enabled: true
  algorithms:
    round_robin:
      enabled: true
      description: "Distribute requests evenly across healthy servers"
      
    weighted_round_robin:
      enabled: true
      description: "Distribute based on server priority and performance"
      weight_factors:
        - "server_priority"
        - "response_time"
        - "success_rate"
        - "current_load"
        
    least_connections:
      enabled: true
      description: "Route to server with fewest active connections"
      
    response_time_based:
      enabled: true
      description: "Route to server with best response time"
      
  default_algorithm: "weighted_round_robin"
  
  balancing_factors:
    server_priority:
      critical_servers: 2.0
      high_priority_servers: 1.5
      normal_servers: 1.0
      low_priority_servers: 0.7
      
    performance_factors:
      response_time_weight: 0.4
      success_rate_weight: 0.3
      throughput_weight: 0.2
      connection_load_weight: 0.1

# Graceful Fallback System
graceful_fallback:
  enabled: true
  
  fallback_strategies:
    server_unavailable:
      detection_criteria:
        - "health_check_failure"
        - "connectivity_timeout"
        - "error_rate_above_threshold"
        
      actions:
        - "remove_from_active_rotation"
        - "attempt_recovery_after_delay"
        - "notify_administrator"
        - "log_incident"
        
    capability_missing:
      detection_criteria:
        - "required_capability_not_available"
        - "version_incompatibility"
        - "security_requirement_not_met"
        
      actions:
        - "find_alternative_server"
        - "use_degraded_functionality"
        - "notify_user_of_limitations"
        - "escalate_if_critical"
        
    system_overload:
      detection_criteria:
        - "all_servers_above_load_threshold"
        - "response_time_degradation"
        - "error_rate_increase"
        
      actions:
        - "implement_request_queuing"
        - "reduce_request_complexity"
        - "increase_timeout_values"
        - "enable_caching_mode"
        
  fallback_chains:
    primary_mcp_servers:
      - "sequential-thinking"
      - "serena"
      - "context7"
      
    backup_mcp_servers:
      - "tavily"
      - "magic"
      - "playwright"
      
    emergency_mode:
      builtin_functionality_only: true
      reduced_capability_set: true
      increased_timeout_values: true

# Version Compatibility Management
version_compatibility:
  enabled: true
  compatibility_matrix:
    mcp_protocol_versions:
      "2.0":
        compatible_with: ["1.0", "1.1", "1.2"]
        deprecated_features: []
        required_features: ["basic_discovery", "health_monitoring"]
        
      "1.2":
        compatible_with: ["1.0", "1.1"]
        deprecated_features: ["legacy_authentication"]
        required_features: ["basic_discovery"]
        
    server_version_management:
      version_check_enabled: true
      auto_update_disabled: true
      compatibility_warning: true
      graceful_degradation: true
      
  upgrade_management:
    rolling_updates:
      enabled: true
      max_concurrent_updates: 1
      health_check_between_updates: true
      
    version_validation:
      validate_capabilities: true
      validate_performance: true
      validate_compatibility: true

# Performance Tracking
performance_tracking:
  enabled: true
  tracking_interval: 60  # seconds
  
  metrics_collected:
    server_metrics:
      - "response_time"
      - "success_rate"
      - "error_rate"
      - "throughput"
      - "connection_count"
      - "memory_usage"
      - "cpu_usage"
      
    registry_metrics:
      - "total_servers_registered"
      - "healthy_servers_count"
      - "failed_servers_count"
      - "average_response_time"
      - "registry_operation_time"
      
    system_metrics:
      - "load_balancing_efficiency"
      - "fallback_activation_count"
      - "discovery_success_rate"
      - "health_check_success_rate"
      
  performance_analysis:
    trend_analysis:
      enabled: true
      analysis_window: "24_hours"
      alert_thresholds:
        response_time_increase: 50
        success_rate_decrease: 20
        error_rate_increase: 100
        
    anomaly_detection:
      enabled: true
      detection_methods:
        - "statistical_outlier_detection"
        - "pattern_based_detection"
        - "machine_learning_detection"
        
    performance_optimization:
      enabled: true
      optimization_methods:
        - "load_balancing_adjustment"
        - "server_prioritization"
        - "timeout_optimization"
        - "caching_strategy_adjustment"

# Security Configuration
security:
  authentication:
    enabled: false
    methods:
      - "api_key"
      - "jwt_token"
      - "mutual_tls"
      
    api_key_config:
      header_name: "X-API-Key"
      validation_endpoint: "/auth/validate"
      
  authorization:
    enabled: false
    access_control:
      read_access: ["system", "admin", "monitoring"]
      write_access: ["system", "admin"]
      admin_access: ["admin"]
      
  encryption:
    transit_encryption: true
    rest_encryption: false
    certificate_validation: true

# Configuration Management
configuration_management:
  hot_reload:
    enabled: true
    watched_files:
      - "config/dynamic/mcp_registry.yaml"
      - "config/mcp_servers/*.yaml"
      
  validation:
    enabled: true
    validation_rules:
      - "syntax_validation"
      - "schema_validation"
      - "connectivity_validation"
      - "capability_validation"
      
  backup_and_recovery:
    automatic_backup: true
    backup_frequency: "hourly"
    backup_retention: "7_days"
    recovery_procedures: true

# API Endpoints
api_endpoints:
  registry_api:
    base_path: "/api/mcp-registry"
    
    server_management:
      register_server: "POST /servers"
      update_server: "PUT /servers/{server_id}"
      deregister_server: "DELETE /servers/{server_id}"
      get_server: "GET /servers/{server_id}"
      list_servers: "GET /servers"
      
    health_management:
      health_check: "GET /health"
      server_health: "GET /servers/{server_id}/health"
      force_health_check: "POST /servers/{server_id}/health-check"
      
    load_balancing:
      get_best_server: "GET /load-balancer/best"
      server_recommendation: "POST /load-balancer/recommend"
      
  monitoring_api:
    base_path: "/api/monitoring"
    
    metrics:
      performance_metrics: "GET /metrics/performance"
      health_metrics: "GET /metrics/health"
      registry_metrics: "GET /metrics/registry"
      
    alerts:
      active_alerts: "GET /alerts"
      acknowledge_alert: "POST /alerts/{alert_id}/acknowledge"

# Error Handling and Recovery
error_handling:
  error_categories:
    network_errors:
      - "connection_timeout"
      - "connection_refused"
      - "dns_resolution_failed"
      
    server_errors:
      - "server_unavailable"
      - "server_overloaded"
      - "server_crashed"
      
    configuration_errors:
      - "invalid_configuration"
      - "missing_required_fields"
      - "version_incompatibility"
      
  recovery_strategies:
    automatic_recovery:
      enabled: true
      max_retry_attempts: 3
      retry_delay: 30  # seconds
      exponential_backoff: true
      
    manual_recovery:
      required_for:
        - "configuration_errors"
        - "security_violations"
        - "persistent_failures"
        
  logging:
    enabled: true
    log_level: "INFO"
    log_rotation: true
    structured_logging: true

# Integration Points
integration:
  dependencies:
    - "runtime_environment_discovery"
    - "health_monitoring_system"
    - "performance_tracking_system"
    
  outputs:
    - "mcp_server_availability_matrix"
    - "load_balancing_decisions"
    - "health_status_updates"
    - "performance_metrics"
    
  notifications:
    channels:
      - "system_logs"
      - "monitoring_dashboard"
      - "alert_system"
      
    events:
      - "server_registered"
      - "server_deregistered"
      - "health_status_changed"
      - "performance_degradation"
      - "fallback_activated"